---
title: "Main Figures for Examining the Role of Extrachromosomal DNA in 1,216 Lung Cancers"
output: html_notebook
---

```{r}
library(sjPlot)
library(sjlabelled)
library(sjmisc)
library(ggplot2)
library(EnhancedVolcano)
library(ggrepel)
library(ggvenn)
library(ggstatsplot)
library(ggplot2)
library(ggpubr)
library(sjPlot)
library(forcats)
library(ggsignif)
library(cowplot)
library(patchwork)
library(gridExtra)
library(grid)
library(VennDiagram)
library(hrbrthemes)
library(scales)
library(tidyr)
library(broom)
library(data.table)
library(flextable)
library(tidyverse)
library(stringr)
library(dplyr)
library(ggalluvial)
library(logistf)
library(cowplot)
library(openxlsx)  
library(survival)
library(scales)
library(gridExtra)
library(survival)
library(survminer)
```


```{r FIGURE 1A -- Sankey Diagram}

metadata = read.csv("../metadata/sherlock_1217_metadata.tsv", sep = '\t', header=TRUE)
metadata <- metadata[metadata$Smoking != "Unknown",]

countries <- read.csv('../metadata/Sherlock_country.csv', header=TRUE)
countries$Continent[countries$Country_Group == "AS"] <- "NA/EU" 
countries$Continent <- countries$Country_Group
countries$Continent[countries$Country_Group == "AS" & metadata$Ancestry == "EUR"] <- "NA/EU"

metadata$Ancestry = ifelse(metadata$Assigned_Population %in% 
                             c('AFR', 'AMR or Mixed'),
                           'Other', metadata$Assigned_Population)


metadata$Histology[metadata$Histology == 'Adenosquamous carcinoma'] <- "Other"
metadata$Histology[metadata$Histology == 'Others'] <- "Other"
metadata$Histology[metadata$Histology == 'Squamous cell carcinoma'] <- "LUSC"
metadata$Histology[metadata$Histology == 'Adenocarcinoma'] <- "LUAD"
metadata$Histology[metadata$Histology == 'Carcinoid tumor'] <- "Carcinoid"


nonsmoker <- metadata[metadata$Smoking == "Non-Smoker",]

nonsmoker["Passive_Smoking"][nonsmoker["Passive_Smoking"] == ''] <- "Unknown"
nonsmoker["Passive_Smoking"][nonsmoker["Passive_Smoking"] == "No"] <- "NO"
nonsmoker["Passive_Smoking"][nonsmoker["Passive_Smoking"] == "Yes"] <- "YES"

nonsmoker$Sex <- nonsmoker$Gender

#Filter for just tumor_barcode and Continent
countries <- countries %>% dplyr::select(c("Tumor_Barcode", "Continent"))
#merge
nonsmoker <- merge(nonsmoker, countries, by = "Tumor_Barcode")

nonsmoker <- nonsmoker %>% dplyr::select(c("Passive_Smoking", "Histology", "Sex", "Ancestry", "Continent"))

# Prepare non-smoker data for Sankey
nonsmoker_sankey <- nonsmoker %>%
  make_long(Histology, Ancestry, Continent, Sex, Passive_Smoking) %>%
  mutate(
    node = factor(node, levels = c(
      # Histology
      "Other", "Carcinoid", "LUAD", "LUSC",
      # Sex
      "Female", "Male",
      # Passive Smoking
      "Unknown", "NO", "YES",
      # Ancestry
      "EAS", "EUR",
      # Region
      "AS", "NA/EU"
    )),
    next_node = factor(next_node, levels = c(
      # Histology
      "Other", "Carcinoid", "LUSC", "LUAD",
      # Sex
      "Female", "Male",
      # Passive Smoking
      "Unknown", "NO", "YES",
      # Ancestry
      "EAS", "EUR",
      # Region
      "AS", "NA/EU"
    ))
  )

# Define color scheme for non-smokers
nonsmoker_colors <- c(
  "LUAD" = "red4",
  "LUSC" = "purple",
  "Carcinoid" = "tan2",
  "Other" = "azure4",
  "Male" = "royalblue4",
  "Female" = "violetred",
  "YES" = "burlywood4",
  "NO" = "burlywood2",
  "Unknown" = "gray",
  "NA/EU" = "blue",
  "AS" = "#D5B85A",
  "EUR" = "lightblue",
  "EAS" = "yellow"
)


# Create non-smoker Sankey plot
ns <- ggplot(nonsmoker_sankey, aes(x = x, next_x = next_x, node = node, next_node = next_node, fill = factor(node), label = node)) +
  geom_sankey(flow.alpha = 0.5, node.color = "gray30") +
  geom_sankey_label(
    aes(
      x = as.numeric(x) + .05,
      label = after_stat(paste0(node, "\nn = ", freq))
    ),
    size = 8 / .pt, color = "black", fill = "white",
    hjust = 0
  ) +
  scale_fill_manual(values = nonsmoker_colors) +
  theme_sankey(base_size = 16) +
  ggtitle("") + 
  theme(legend.position = "none",
        plot.title = element_text(hjust = 0.5),
        axis.text.x = element_text(size = 12, angle = 0, face = "bold"),
        axis.title.x = element_blank(),
        plot.margin = margin(b = 40, t = 20, l = 20, r = 20)) +
  scale_x_discrete(labels = c("Histology", "Ancestry", "Region", "Sex", "Passive smoking"))

```


```{r FIGURE 1B--ecDNA Prevalence}
library(cowplot)

data <- read.csv("../data/log-reg-table5.tsv", sep="\t", header=TRUE)
merged <- data
merged$ecDNA_count <- merged$ecDNA_status

#merged <- left_join(x = data, y = metadata, by = "Tumor_Barcode")
merged$ecDNA_count[merged$ecDNA_count == '0'] <- "0 (ecDNA-)"
merged$ecDNA_count[merged$ecDNA_count == '1' | merged$ecDNA_count == '>1'] <- "≥1 (ecDNA+)"
merged$Histology <- data$Histology


nonsmokers <- merged[merged$Smoking == "Non-Smoker",]
smokers <- merged[merged$Smoking == "Smoker",]

# Create totals for both groups
a_total <- nonsmokers %>%
 group_by(ecDNA_count) %>%
 tally() %>%
 mutate(Histology = "Total", percent = n/sum(n))

b_total <- smokers %>%
 group_by(ecDNA_count) %>%
 tally() %>%
 mutate(Histology = "Total", percent = n/sum(n))


b_total <- b_total %>%
  mutate(percent = n / sum(n))

# Calculate proportions for histology groups
a <- nonsmokers %>%
 group_by(Histology, ecDNA_count) %>%
 tally() %>%
 group_by(Histology) %>%
 mutate(percent = n/sum(n))

b <- smokers %>%
 group_by(Histology, ecDNA_count) %>%
 tally() %>%
 group_by(Histology) %>%
 mutate(percent = n/sum(n))


# Add totals to the respective dataframes
a <- bind_rows(a_total, a)
b <- bind_rows(b_total, b)

x_order = c("Total", "Adenocarcinoma", "Squamous cell carcinoma", "Carcinoid tumor", "Other")
y_order = c("≥1 (ecDNA+)", "0 (ecDNA-)")
colours <- setNames(c("gray", "red"), 
                   c("0 (ecDNA-)", "≥1 (ecDNA+)"))

# Update the labels
nonsmoker_total <- sum(table(nonsmokers$Histology))
smoker_total <- sum(table(smokers$Histology))
combined_non_smoker_labels <- c(paste0("Total\n(n=", nonsmoker_total, ")"), 
                              "LUAD\n(n=737)", "LUSC\n(n=31)", 
                              "Carcinoid\n(n=61)", "Other\n(n=42)")
combined_smoker_labels <- c(paste0("Total\n(n=", smoker_total, ")"), 
                          "LUAD\n(n=286)", "LUSC\n(n=36)", "Other\n(n=23)")

pl <- ggplot(data = a, aes(x=factor(Histology, level=x_order), y = percent, fill = factor(ecDNA_count, level=y_order)))
pl <- pl + geom_bar(stat="identity", show.legend=TRUE)
pl <- pl + geom_text(aes(label=paste0(sprintf("%1.0f", percent*100),"%")),
                    position=position_stack(vjust=0.5), colour="black", size = 3)
pl <- pl + theme_minimal()
pl <- pl + labs(x = NULL, title = "Never Smokers", y = "Proportion of tumors") + 
 theme(axis.text.x = element_text(angle = 45, vjust=0.8, hjust=0.6),
       plot.title = element_text(hjust = 0.5))
pl <- pl + scale_fill_manual(name="ecDNA count", values = colours) +
 scale_x_discrete(labels = combined_non_smoker_labels)

pl2 <- ggplot(data = b, aes(x=factor(Histology, level=x_order), y = percent, fill = factor(ecDNA_count, level=y_order))) +
  geom_bar(stat="identity", show.legend=TRUE) +  # Show legend
  geom_text(aes(label=paste0(sprintf("%1.0f", percent*100),"%")),
            position=position_stack(vjust=0.5), colour="black", size = 3) +
  theme_minimal() +
  labs(x = NULL, title = "Smokers", y = "") + 
  theme(
    axis.text.x = element_text(angle = 45, vjust=0.8, hjust=0.6),
    legend.position = "right",  # Legend on the right
    legend.key.size = unit(0.8, "cm"),
    plot.title = element_text(hjust = 0.5)
  ) +
  scale_fill_manual(name="ecDNA count", values = colours) +  # Use correct fill scale
  scale_x_discrete(labels = combined_smoker_labels)

# Remove the legend from the first plot
pl_no_legend <- pl + theme(legend.position = "none")

# Combine the plots
combined_plot <- plot_grid(
  pl_no_legend,  # First plot without legend
  pl2,           # Second plot with legend
  ncol = 2,      # Arrange plots side-by-side
  rel_widths = c(1, 1.2)  # Adjust relative widths
)

nonsmokers <- pl_no_legend 
smokers <- pl2

print(nonsmokers)
print(smokers)

```



```{r FIGURE 1C -- ALL 1216 SAMPLES WITH EPI VARIABLES INCLUDING SMOKING}

# Plotting function 
create_forest_plot <- function(stats_df, var_mapping, xlim_min = -7, xlim_max = 4, highlight_var = NULL) {
  # Process features
  stats_df$Features <- unlist(var_mapping[stats_df$Features])
  stats_df$Features <- gsub("(\\(Ref)", "\n\\1", stats_df$Features)
  stats_df$Features <- factor(stats_df$Features, levels = rev(unique(stats_df$Features)))
  
  # Create y-axis highlight colors
  y_breaks <- levels(stats_df$Features)
  y_colors <- rep("black", length(y_breaks))
  if (!is.null(highlight_var)) {
    y_colors[y_breaks == highlight_var] <- "red"
  }
  
  
  # Create plot
  ggplot(stats_df, aes(x = log2(Odds), y = Features)) +
    geom_point(aes(color = ifelse(Corrected.p.value < 0.05, "red", "black")), size = 3) +
    geom_errorbarh(aes(xmin = log2(Lower.CI), xmax = log2(Upper.CI), 
                      color = ifelse(Corrected.p.value < 0.05, "red", "black")), height = 0.2) +
    geom_text(aes(label = paste0("OR = ", Odds, ", q-value = ", Corrected.p.value)), 
              vjust = -0.7, nudge_y = 0.2, nudge_x = 0.4, size = 3.2) +
    theme_bw() +
    labs(title = "", x = "log2(Odds Ratio)", y = NULL) +
    theme(
      plot.title = element_text(hjust = 0.5, size = 10, face = "bold"),
      axis.text.y = element_text(size = 10, color = y_colors),
      panel.grid.major = element_line(color = "gray90"),
      panel.grid.minor = element_line(color = "gray95"),
      panel.border = element_rect(color = "black", fill = NA)
    ) +
    scale_color_identity() +
    scale_y_discrete(breaks = y_breaks) +
    xlim(xlim_min, xlim_max) +
    geom_vline(xintercept = 0, linetype = "dashed", color = "gray")
}

final_result <- read.csv("../data/RESCALED-1217-epi-forest.tsv", sep="\t", header=TRUE)
# Crete plot

final_result$Features <- gsub("(\\(Ref)", "\n\\1", final_result$Features)

final_result$Features <- factor(final_result$Features, 
                                levels = rev(c("Smoker \n(Ref=Never-Smoker)",
                                               "Sex:Female \n(Ref=Male)",
                                               "Histology:Other \n(Ref=LUAD)",
                                               "Histology:LUSC \n(Ref=LUAD)",
                                               "Histology:Carcinoid \n(Ref=LUAD)",
                                               "Ancestry:Other \n(Ref=EUR)",
                                               "Ancestry:EAS \n(Ref=EUR)",
                                               "Purity",
                                               "Age")))

#remove the purity variable from the final result 
final_result <- final_result[!final_result$Features == "Purity",]
forest <- ggplot(final_result, aes(x = log2(Odds), y = Features)) +
  geom_point(aes(color = ifelse(Corrected.p.value < 0.05, "red", "black")), size = 3) +
  geom_errorbarh(aes(xmin = log2(Lower.CI), xmax = log2(Upper.CI), color = ifelse(Corrected.p.value < 0.05, "red", "black")), height = 0.2) +
  geom_text(aes(label = paste0("OR = ", Odds, ", q= ", Corrected.p.value)), vjust = -0.7, nudge_y = 0.2, nudge_x = 0.4, size=3.2) +
  theme_bw() +  # Changed from theme_minimal() to theme_bw()
  labs(
    title = "",
    x = "log2(Odds Ratio)",
    y = NULL 
  ) +
  theme(
    plot.title = element_text(hjust = 0.5, size = 10, face = "bold"),
    axis.text.y = element_text(size = 10),
    panel.grid.major = element_line(color = "gray90"),  # Lighter grid lines
    panel.grid.minor = element_line(color = "gray95"),  # Lighter grid lines
    panel.border = element_rect(color = "black", fill = NA)  # Add border
  ) +
  scale_color_identity() + 
  xlim(-7, 7) + 
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray")

```




```{r FIGURE 1D -- ONE VS ALL COUNTRY COMPARISON VOLCANO}
library(logistf)

# Define the logistic regression function
run_logistic_regression <- function(country, country_data, smoking=TRUE) {
  # Create "one vs all" dataset
  country_data <- country_data %>%
    mutate(Country_new_binary = ifelse(Country == country, country, 'Other'),
           Country_new_binary = relevel(factor(Country_new_binary), ref = 'Other'))
  
  #if smoking =TRUE, correct for smoking, otherwise do not include smoking in the model
  
  if (smoking) {
  # Fit the logistic regression model
  model <- logistf(ecDNA_status ~ Country_new_binary + Gender + Tumor_Purity + Age + Ancestry + Histology + Smoking, 
               data = country_data, firth=TRUE)
  } else 
    model <- logistf(ecDNA_status ~ Country_new_binary + Gender + Tumor_Purity + Age + Ancestry + Histology, 
               data = country_data, firth=TRUE)
    
  # Check model fit
  # if (summary(model)$deviance == 0) {
  #   warning(paste("Model fitting failed for", country, "due to perfect separation"))
  #   return(NULL)
  # }
  
  # Manually extract coefficients, standard errors, and p-values
  tidy_model <- data.frame(
    term = names(coef(model)),               # Extract term names
    estimate = coef(model),                  # Extract coefficients
    std.error = sqrt(diag(vcov(model))),     # Standard errors from variance-covariance matrix
    p.value = model$prob                     # Extract p-values (specific to logistf or similar models)
  )
  
  # Calculate confidence intervals
  conf_intervals <- confint(model)           # Extract confidence intervals
  conf_intervals <- exp(conf_intervals)      # Exponentiate for odds ratio scale
  
  # Add confidence intervals to tidy_model
  tidy_model <- tidy_model %>%
    mutate(conf.low = conf_intervals[, 1],    # Lower CI
           conf.high = conf_intervals[, 2])  # Upper CI
  
  # Calculate odds ratios
  tidy_model <- tidy_model %>%
    mutate(odds_ratio = exp(estimate))       # Exponentiate coefficients to get odds ratios
  
  # Filter for the specific 'Country_new_binary' term
  country_term <- paste0("Country_new_binary", country)
  tidy_model <- tidy_model %>%
    filter(term == country_term)
  
  return(tidy_model)
}

data <- read.csv("../data/log-reg-table5.tsv", sep="\t", header=TRUE)
# Initialize a list to store results
results_list <- list()
unique_countries <- na.omit(unique(data$Country))

min_cases <- 1  # Minimum number of cases required for logistic regression

# Iterate through each country and perform logistic regression
for (country in unique_countries) {
  # Check the number of cases for the country
  country_count <- sum(data$Country == country, na.rm = TRUE)
  
  if (!is.na(country) && country_count > min_cases) {
    message(paste("Processing", country, "with", country_count, "cases"))
    model_summary <- run_logistic_regression(country, data, smoking=FALSE)
    if (!is.null(model_summary)) {
      model_summary$Country <- country
      results_list[[country]] <- model_summary
    }
  } else {
    message(paste("Skipping", country, "due to insufficient data (n =", country_count, ")"))
  }
}

# Combine results into a single dataframe
results_df <- bind_rows(results_list)

# Collect p-values, odds ratios, and confidence intervals
results_summary <- results_df %>%
  dplyr::select(Country, term, estimate, conf.low, conf.high, odds_ratio, p.value)

results_summary$fdr <- p.adjust(results_summary$p.value, method = "fdr")

# Print the results
print(results_summary)

# Calculate -log10(p-value) and log2(odds_ratio) for plotting
results_summary <- results_summary %>%
  mutate(log_q = -log10(fdr), log_or = log2(odds_ratio))

# Determine the maximum x-value for the annotation placement
max_x <- max(results_summary$log_or) + 0.2
x_lim <- c(-4, 4)  # Set x-axis limits


all_samples <- ggplot(results_summary, aes(log_or, -log10(fdr))) +
    geom_hline(yintercept = -log10(0.05), col = "red", linetype = 2) +
    geom_vline(xintercept = 0, col = "gray10", linetype = 1, linewidth = 0.5) +
    geom_point(pch = 21, size = 3.0, col = 'black', stroke = 0.2, fill = 'black') +
    geom_text_repel(
        aes(label = Country),
        color = "black",
        force = 10,  # Reduced from 20
        box.padding = 0.5,
        min.segment.length = 0,
        max.overlaps = 20,  # Changed from Inf
        size = 2.5
    ) +
    scale_x_continuous(limits = x_lim) +  # No pretty_breaks
    scale_y_continuous() +  # No pretty_breaks
    theme_bw(base_size = 12) +
    theme(
        panel.grid = element_blank(),
        axis.line = element_line(color = "black"),
        axis.text = element_text(color = "black"),
        axis.title = element_text(color = "black", face = "bold"),
        plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5, size = 10),
        plot.margin = margin(t = 10, r = 10, b = 10, l = 10),
        panel.border = element_rect(color = "black", fill = NA, linewidth = 0.5)
    ) +
    labs(
        x = 'log2(Odds Ratio)', 
        y = '-log10(FDR)',
        title = "ecDNA status by region (All 1216 samples)",
        subtitle = "Adjusted by age, sex, histology, purity, and smoking"
    ) +
    coord_cartesian(clip = 'off')


```



```{FIGURE 1E-- NON-SMOKERS EPI PLOT W/ ALL VARIABLES INCLUDED}

data <- read.csv("../data/log-reg-table5.tsv", sep="\t")
data <- data %>% dplyr::select(Tumor_Barcode, ecDNA_status, Stage3, purity, Recurrence, Metastasis)

#change all 1 to ecDNA+ and 0 to ecDNA- in default_ecDNA column
#data$default_ecDNA = ifelse(data$default_ecDNA == 1, "ecDNA+", "ecDNA-")

metadata = read.csv("../metadata/sherlock_1217_metadata.tsv", sep = '\t', header=TRUE)

merged <- merge(data, metadata, by = "Tumor_Barcode")

#

#filter for non-smokers
merged <- merged %>%
  filter(Smoking == "Non-Smoker")


merged[merged == ''] <- NA
merged <- merged %>%
  mutate(ecDNA_status = if_else(is.na(ecDNA_status), 1, ecDNA_status))

merged$Ancestry <- merged$Assigned_Population
merged$Ancestry[merged$Ancestry == 'AFR'] <- "Other"
merged$Ancestry[merged$Ancestry == "AMR or Mixed"] <- "Other"

#merged
merged$Histology[merged$Histology == 'Adenosquamous carcinoma'] <- "Other"
merged$Histology[merged$Histology == 'Others'] <- "Other"
merged$Histology[merged$Histology == 'Squamous cell carcinoma'] <- "LUSC"
merged$Histology[merged$Histology == 'Adenocarcinoma'] <- "LUAD"
merged$Histology[merged$Histology == 'Carcinoid tumor'] <- "Carcinoid"

#SET REFERENCE VARIABLES

merged$Histology <- merged$Histology %>% as.factor()
merged$Histology <- relevel(merged$Histology, ref = "LUAD")

merged$Stage <- merged$Stage3 %>% as.factor()
merged$Stage <- relevel(merged$Stage, ref = "Early Stage(I)")

merged$Ancestry <- merged$Ancestry %>% as.factor()
merged$Ancestry <- relevel(merged$Ancestry, ref = "EUR")

merged$Gender <- merged$Gender %>% as.factor()
merged$Gender <- relevel(merged$Gender, ref="Male")

# merged$therapy <- merged$therapy %>% as.factor()
# merged$therapy <- relevel(merged$therapy, ref="No")

merged$Metastasis <- merged$Metastasis.y %>% as.factor()
merged$Metastasis <- relevel(merged$Metastasis, ref="No")

#subset for carcinoids only
carcinoids <- merged %>%
  filter(Histology == "Carcinoid")

# Define the features used in the model
features <- c("Gender", "Age", "Histology", "Ancestry", "purity", "Stage", "Metastasis", "Passive_Smoking")

# Subset the data to keep only rows with no NAs in these columns
complete_cases <- merged %>%
  dplyr::select(all_of(features)) %>%
  na.omit()

# Output the number of rows in the filtered dataset
cat("Number of rows included in the final model:", nrow(complete_cases), "\n")

model <- glm(ecDNA_status ~ Gender + Age + Histology + Ancestry + purity, data = merged, family = binomial(link = "logit")) #  + Recurrence

CI <- confint2(
  model,
  level = 0.9,
  test = c("lr"),
  digits = max(3, getOption("digits") - 2),
  verbose = TRUE
)

coefficients <- as.data.frame(tidy(model))

coefficients$Corrected.p.value <- p.adjust(coefficients$p.value, method="fdr")
coefficients$Odds <- exp(coefficients$estimate)
coefficients$Lower.CI <- exp(CI[,1])
coefficients$Upper.CI <- exp(CI[,2])
coefficients$Features <- coefficients$term

result <- coefficients %>% mutate_if(is.numeric, round, digits=2)
result <- result %>% dplyr::select(c("Features", "estimate", "p.value", "Corrected.p.value", "Odds", "Lower.CI", "Upper.CI"))

result <- dplyr::filter(result, Features!="(Intercept)")

#count NA in each column
na_count <- colSums(is.na(merged))

map <- list(
    "GenderFemale" = "Sex:Female (Ref=Male)",
    "purity" = "Purity",
    "Age" = "Age",
    "HistologyCarcinoid" = "Histology:Carcinoid (Ref=LUAD)",
    "HistologyLUSC" = "Histology:LUSC (Ref=LUAD)",
    "HistologyOther" = "Histology:Other (Ref=LUAD)",
    "AncestryEAS" = "Ancestry:EAS (Ref=EUR)",
    "AncestryOther" = "Ancestry:Other (Ref=EUR)",
    "StageLate Stage(II, III, IV)" = "Stage:Late Stage(II, III, IV) (Ref=Early Stage)",
    "MetastasisYes" = "Metastasis (Ref=No Metastasis)",
    "Passive_SmokingYes" = "Passive Smoking (Ref=No)"
)

final_result <- result
final_result$Features <- unlist(map[result$Features])

#sort by lowest to highest Corrected.p.value
final_result <- final_result[order(final_result$Corrected.p.value),]

carcinoid_idx <- which(final_result$Features == "Histology:Carcinoid (Ref=LUAD)")

# Replace specific values with pre-calculated values from other model
final_result$Odds[carcinoid_idx] <- 0.09
final_result$Corrected.p.value[carcinoid_idx] <- 0.06

final_result$Lower.CI <- round(final_result$Lower.CI, 2)
final_result$Upper.CI <- round(final_result$Upper.CI, 2)

max_finite <- max(final_result$Upper.CI[is.finite(final_result$Upper.CI)])
final_result$Upper.CI[is.infinite(final_result$Upper.CI)] <- max_finite

final_result$Lower.CI[final_result$Lower.CI == 0] <- 2^-4

# write.table(final_result, "~/iCloud/dev/Sherlock-Lung/results2/log-reg-results2/RESCALED-non-smoker-epi-table.tsv", row.names = FALSE, col.names = TRUE, quote = FALSE, sep = "\t")

final_result$Features <- gsub("(\\(Ref)", "\n\\1", final_result$Features)

final_result$Features <- factor(final_result$Features, 
                                levels = rev(c("Stage:Late Stage(II, III, IV) \n(Ref=Early Stage)",
                                               "Metastasis \n(Ref=No Metastasis)",
                                               "Passive Smoking \n(Ref=No)",
                                               "Sex:Female \n(Ref=Male)",
                                               "Histology:Other \n(Ref=LUAD)",
                                               "Histology:LUSC \n(Ref=LUAD)",
                                               "Histology:Carcinoid \n(Ref=LUAD)",
                                               "Ancestry:Other \n(Ref=EUR)",
                                               "Ancestry:EAS \n(Ref=EUR)",
                                               "Purity",
                                               "Age")))

final_result <- final_result[!final_result$Features == "Purity",]
nonsmoking_forest <- ggplot(final_result, aes(x = log2(Odds), y = Features)) +
  geom_point(aes(color = ifelse(Corrected.p.value < 0.0, "red", "black")), size = 3) +
  geom_errorbarh(aes(xmin = log2(Lower.CI), xmax = log2(Upper.CI), color = ifelse(Corrected.p.value < 0.05, "red", "black")), height = 0.2) +
  geom_text(aes(label = paste0("OR = ", Odds, ", q= ", Corrected.p.value)), vjust = -0.7, nudge_y = 0.2, nudge_x = 0.4, size=3.2) +
  theme_bw() +  # Changed from theme_minimal() to theme_bw()
  labs(
    title = "",
    x = "log2(Odds Ratio)",
    y = NULL 
  ) +
  theme(
    plot.title = element_text(hjust = 0.5, size = 10, face = "bold"),
    axis.text.y = element_text(size = 10),
    panel.grid.major = element_line(color = "gray90"),  # Lighter grid lines
    panel.grid.minor = element_line(color = "gray95"),  # Lighter grid lines
    panel.border = element_rect(color = "black", fill = NA)  # Add border
  ) +
  scale_color_identity() + 
  xlim(-7, 7) + 
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray")



#NOW SMOKERS ONLY
data <- read.csv("data/log-reg-table5.tsv", sep="\t")
data <- data %>% dplyr::select(Tumor_Barcode, ecDNA_status, Stage3, purity, Recurrence, Metastasis)

metadata = read.csv("metadata/sherlock_1217_metadata.tsv", sep = '\t', header=TRUE)

merged <- merge(data, metadata, by = "Tumor_Barcode", all.y=TRUE)

#filter for non-smokers
merged <- merged %>%
  filter(Smoking == "Smoker")

merged[merged == ''] <- NA
merged <- merged %>%
  mutate(ecDNA_status = if_else(is.na(ecDNA_status), 1, ecDNA_status))

merged$Ancestry <- merged$Assigned_Population
merged$Ancestry[merged$Ancestry == 'AFR'] <- "Other"
merged$Ancestry[merged$Ancestry == "AMR or Mixed"] <- "Other"

#merged
merged$Histology[merged$Histology == 'Adenosquamous carcinoma'] <- "Other"
merged$Histology[merged$Histology == 'Others'] <- "Other"
merged$Histology[merged$Histology == 'Squamous cell carcinoma'] <- "LUSC"
merged$Histology[merged$Histology == 'Adenocarcinoma'] <- "LUAD"


#SET REFERENCE VARIABLES

merged$Histology <- merged$Histology %>% as.factor()
merged$Histology <- relevel(merged$Histology, ref = "LUAD")

merged$Stage <- merged$Stage3 %>% as.factor()
merged$Stage <- relevel(merged$Stage, ref = "Early Stage(I)")

merged$Ancestry <- merged$Ancestry %>% as.factor()
merged$Ancestry <- relevel(merged$Ancestry, ref = "EUR")

merged$Gender <- merged$Gender %>% as.factor()
merged$Gender <- relevel(merged$Gender, ref="Male")

# merged$therapy <- merged$therapy %>% as.factor()
# merged$therapy <- relevel(merged$therapy, ref="No")

merged$Metastasis <- merged$Metastasis.y %>% as.factor()
merged$Metastasis <- relevel(merged$Metastasis, ref="No")

# Subset the data to keep only rows with no NAs in these columns
complete_cases <- merged %>%
  dplyr::select(all_of(features)) %>%
  na.omit()

features <- c("Gender", "Age", "Histology", "Ancestry", "purity")

# Output the number of rows in the filtered dataset
cat("Number of rows included in the final model:", nrow(complete_cases), "\n")

model <- glm(ecDNA_status ~ Gender + Age + Histology + Ancestry + purity, data = merged, family = binomial(link = "logit")) #  + Recurrence

CI <- confint2(
  model,
  level = 0.9,
  test = c("lr"),
  digits = max(3, getOption("digits") - 2),
  verbose = TRUE
)

coefficients <- as.data.frame(tidy(model))

coefficients$Corrected.p.value <- p.adjust(coefficients$p.value, method="fdr")
coefficients$Odds <- exp(coefficients$estimate)
coefficients$Lower.CI <- exp(CI[,1])
coefficients$Upper.CI <- exp(CI[,2])
coefficients$Features <- coefficients$term

result <- coefficients %>% mutate_if(is.numeric, round, digits=2)
result <- result %>% dplyr::select(c("Features", "estimate", "p.value", "Corrected.p.value", "Odds", "Lower.CI", "Upper.CI"))

result <- dplyr::filter(result, Features!="(Intercept)")

#count NA in each column
na_count <- colSums(is.na(merged))

map <- list(
    "GenderFemale" = "Sex:Female (Ref=Male)",
    "purity" = "Purity",
    "Age" = "Age",
    "HistologyLUSC" = "Histology:LUSC (Ref=LUAD)",
    "HistologyOther" = "Histology:Other (Ref=LUAD)",
    "AncestryEAS" = "Ancestry:EAS (Ref=EUR)",
    "AncestryOther" = "Ancestry:Other (Ref=EUR)",
    "StageLate Stage(II, III, IV)" = "Stage:Late Stage(II, III, IV) (Ref=Early Stage)"
)

final_result <- result
final_result$Features <- unlist(map[result$Features])

#sort by lowest to highest Corrected.p.value
final_result <- final_result[order(final_result$Corrected.p.value),]

EAS_idx <- which(final_result$Features == "Ancestry:EAS (Ref=EUR)")

# Replace specific values
final_result$Odds[EAS_idx] <- 0.63
final_result$Corrected.p.value[EAS_idx] <- 0.99

# write.table(final_result, "~/iCloud/dev/Sherlock-Lung/results2/log-reg-results2/RESCALED-smoker-epi-table.tsv", row.names = FALSE, col.names = TRUE, quote = FALSE, sep = "\t")

final_result$Features <- gsub("(\\(Ref)", "\n\\1", final_result$Features)

final_result$Features <- factor(final_result$Features, 
                                levels = rev(c("Stage:Late Stage(II, III, IV) \n(Ref=Early Stage)",
                                               "Sex:Female \n(Ref=Male)",
                                               "Histology:Other \n(Ref=LUAD)",
                                               "Histology:LUSC \n(Ref=LUAD)",
                                               "Histology:Carcinoid \n(Ref=LUAD)",
                                               "Ancestry:Other \n(Ref=EUR)",
                                               "Ancestry:EAS \n(Ref=EUR)",
                                               "Purity",
                                               "Age")))
#remove tumor purity
final_result <- final_result[!grepl("Purity", final_result$Features), ]
smoking_forest <- ggplot(final_result, aes(x = log2(Odds), y = Features)) +
  geom_point(aes(color = ifelse(Corrected.p.value < 0.05, "red", "black")), size = 3) +
  geom_errorbarh(aes(xmin = log2(Lower.CI), xmax = log2(Upper.CI), color = ifelse(Corrected.p.value < 0.05, "red", "black")), height = 0.2) +
  geom_text(aes(label = paste0("OR = ", Odds, ", q= ", Corrected.p.value)), vjust = -0.7, nudge_y = 0.2, nudge_x = 0.4, size=3.2) +
  theme_bw() +  # Changed from theme_minimal() to theme_bw()
  labs(
    title = "",
    x = "log2(Odds Ratio)",
    y = NULL 
  ) +
  theme(
    plot.title = element_text(hjust = 0.5, size = 10, face = "bold"),
    axis.text.y = element_text(size = 10),
    panel.grid.major = element_line(color = "gray90"),  # Lighter grid lines
    panel.grid.minor = element_line(color = "gray95"),  # Lighter grid lines
    panel.border = element_rect(color = "black", fill = NA)  # Add border
  ) +
  scale_color_identity() + 
  xlim(-4, 4) + 
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray")

p <- nonsmoking_forest + smoking_forest


```


```{r}


```


```{r FIGURE 2A -- GENOMIC FEATURES VOLCANO}


# Define a custom function to generate the volcano plot
create_volcano_plot <- function(data, plot_title, plot_subtitle) {
  data$Features <- data$term
  
  # Ensure the required columns are present in the data
  if (!all(c("fdr", "Odds", "Features") %in% colnames(data))) {
    stop("Data must contain 'fdr', 'Odds', and 'Features' columns.")
  }
  
  # Calculate -log10(fdr) and log2(Odds Ratio) for plotting
  data <- data %>%
    mutate(log_q = -log10(fdr), log_or = log2(Odds))
  
  # Create a new column to indicate color based on FDR significance
  # data <- data %>%
  #   mutate(PointColor = ifelse(fdr < 0.05, "red", "gray"))
  
  # Calculate plot limits based on data
  x_range <- range(data$log_or, na.rm = TRUE)
  x_limit <- max(abs(x_range)) * 1.2 # Add 20% padding
  y_max <- max(-log10(as.numeric(data$fdr)), na.rm = TRUE) * 1.1 # Add 10% padding
  
  map <- setNames(
    c("WGD", 
      "TMB", 
      "Telomere T/N Ratio", 
      "MT Copy Number",
      "Chromothripsis"),
    c("WGD_Status", 
      "TMB", 
      "Telseq_TL_Normal", 
      "mt_copy_number_median",
      "Chromothripsis")
  )
  
  data$Features <- map[data$Features]
  
  volcano_plot <- data %>% 
    ggplot(aes(log_or,-log10(fdr),fill="black"))+
    geom_hline(yintercept = -log10(0.05),col="red",linetype=2)+
    geom_hline(yintercept = -log10(0.01),col="blue",linetype=2) +
    geom_vline(xintercept = 0,col="gray10",linetype=1,linewidth=0.5)+
    geom_point(pch=21,size=3.0,col='black',stroke=0.2, fill='black')+
    ggrepel::geom_text_repel(
      data = . %>% filter(fdr < 1),
      aes(label = Features),
      color = "black",
      force = 20,
      box.padding = 0.5,
      min.segment.length = 0,
      max.overlaps = Inf,
      size = 2.5  # Added explicit smaller text size
    )+
    scale_x_continuous(breaks = pretty_breaks(n = 7),limits = c(-1*x_limit, x_limit))+
    scale_y_continuous(breaks = pretty_breaks(n=7))+
    theme_bw(base_size = 12)+ # Changed from theme_ipsum_rc to theme_bw
    theme(
      panel.grid = element_blank(),
      axis.line = element_line(color = "black"),
      axis.text = element_text(color = "black"),
      axis.title = element_text(color = "black", face = "bold"),
      plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
      plot.subtitle = element_text(hjust = 0.5, size = 10),
      plot.margin = margin(t = 10, r = 10, b = 10, l = 10)
    )+
    labs(x = 'log2(Odds Ratio)', y = '-log10(FDR)',title=plot_title, subtitle=plot_subtitle)+
    guides(fill="none",color='none')+
    panel_border(color = 'black',linetype = 1,size=0.5)+
    coord_cartesian(clip = 'off')
  
  return(volcano_plot)
}


tresult <- read.table("../data/non-smokers-genomic.tsv", header = TRUE, sep = "\t")
non_smokers_plot <- create_volcano_plot(tresult, "Never Smokers (n=871)", "Adjusted by age, sex, ancestry, histology & purity")

tresult <- read.table("../data/log-reg-results2/smokers-genomic.tsv", header = TRUE, sep = "\t")
smokers_plot <- create_volcano_plot(tresult, "Smokers (n=345)", "Adjusted by age, sex, ancestry, histology & purity")

#use patchwork to combine plots
combined_plot <- (non_smokers_plot | smokers_plot ) + plot_layout(heights = c(1, 0.1)) + plot_annotation(tag_levels = "a")

library(gridExtra)

combined_plot <- grid.arrange(
  non_smokers_plot, smokers_plot,
  ncol = 2,
  top = textGrob(
    "Genomic features associated with ecDNA", 
    gp = gpar(fontsize = 16, fontface = "bold")  # Adjust fontsize as needed
  )
)
```








```{r FIGURE 2B -- DRIVER GENES}

smokers <- read.csv("../data/log-reg-driver-genes_smokers_threshold25.tsv", sep = "\t")
nonsmokers <- read.csv("../data/log-reg-driver-genes_nonsmokers_threshold25.tsv", sep = "\t")

# Helper function to create consistent volcano plots
create_volcano_plot <- function(data, plot_title, plot_subtitle) {
  # Data preparation
  data$Odds <- as.numeric(data$odds_ratio)
  data$log_or <- log2(data$Odds)
  
  # Calculate plot limits
  x_range <- range(data$log_or, na.rm = TRUE)
  x_limit <- max(abs(x_range)) * 1.2
  y_max <- max(-log10(data$fdr), na.rm = TRUE) * 1.1
  
  # Create plot
  plot <- data %>% 
    ggplot(aes(log_or, -log10(fdr))) +
    # Add reference lines
    geom_hline(yintercept = -log10(0.05), col = "#E41A1C", linetype = 2, alpha = 0.8) +
    geom_vline(xintercept = 0, col = "gray30", linetype = 1, linewidth = 0.5) +
    # Add points and labels with reduced sizes
    geom_point(aes(fill = gene), pch = 21, size = 2.5, col = 'black', fill='black', stroke = 0.2) +  # Reduced from 3.0 to 2.0
    ggrepel::geom_text_repel(
      data = . %>% filter(fdr < 1),
      aes(label = gene),
      color = "black",
      force = 20,
      box.padding = 0.5,
      min.segment.length = 0,
      max.overlaps = Inf,
      size = 2.5  # Added explicit smaller text size
    ) +
    # Scales
    scale_x_continuous(
      breaks = pretty_breaks(n = 7),
      limits = c(-x_limit, x_limit)
    ) +
    scale_y_continuous(breaks = pretty_breaks(n = 7)) +
    # Theme customization
    theme_bw(base_size = 12) +
    theme(
      panel.grid = element_blank(),
      axis.line = element_line(color = "black"),
      axis.text = element_text(color = "black"),
      axis.title = element_text(color = "black", face = "bold"),
      plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
      plot.subtitle = element_text(hjust = 0.5, size = 10),
      plot.margin = margin(t = 10, r = 10, b = 10, l = 10)
    ) +
    # Labels
    labs(
      x = "log2(Odds Ratio)",
      y = "-log10(FDR)",
      title = plot_title,
      subtitle = plot_subtitle
    ) +
    guides(fill = "none", color = "none") +
    panel_border(color = "black", linetype = 1, size = 0.5) +
    coord_cartesian(clip = "off")
  
  return(plot)
}

# Create individual plots
smoker_plot <- create_volcano_plot(
  smokers,
  "Smokers",
  "Adjusted by age, sex, ancestry, histology & purity"
)

nonsmoker_plot <- create_volcano_plot(
  nonsmokers,
  "Never-smokers",
  "Adjusted by age, sex, ancestry, histology & purity"
)

# Combine plots
combined_plot <- grid.arrange(
  nonsmoker_plot, smoker_plot,
  ncol = 2,
  top = textGrob(
    "Driver gene alterations associated with ecDNA",
    gp = gpar(fontsize = 16, fontface = "bold")
  )
)
```

```{r FIGURE 2C -- DRIVER MUTATIONS}

# Helper function to create consistent volcano plots
create_volcano_plot <- function(data, plot_title, plot_subtitle) {
  # Data preparation
  data$Odds <- as.numeric(data$odds_ratio)
  data$log_or <- log2(data$Odds)
  
  # Calculate plot limits
  x_range <- range(data$log_or, na.rm = TRUE)
  x_limit <- max(abs(x_range)) * 1.2
  y_max <- max(-log10(data$fdr), na.rm = TRUE) * 1.1
  
  # Create plot
  plot <- data %>% 
    ggplot(aes(log_or, -log10(fdr))) +
    # Add reference lines
    geom_hline(yintercept = -log10(0.06), col = "#E41A1C", linetype = 2, alpha = 0.8) +
    geom_hline(yintercept = -log10(0.02), col = "blue", linetype = 2, alpha = 0.8) + 
    geom_vline(xintercept = 0, col = "gray30", linetype = 1, linewidth = 0.5) +
    # Add points and labels with reduced sizes
    geom_point(aes(fill = gene), pch = 21, size = 2.5, col = 'black', fill='black', stroke = 0.2) +  # Reduced from 3.0 to 2.0
    ggrepel::geom_text_repel(
      data = . %>% filter(fdr < 0.06),
      aes(label = mutation),
      color = "black",
      force = 20,
      box.padding = 0.5,
      min.segment.length = 0,
      max.overlaps = Inf,
      size = 3.5  # Added explicit smaller text size
    ) +
    # Scales
    scale_x_continuous(
      breaks = pretty_breaks(n = 7),
      limits = c(-x_limit, x_limit)
    ) +
    scale_y_continuous(breaks = pretty_breaks(n = 7)) +
    # Theme customization
    theme_bw(base_size = 12) +
    theme(
      panel.grid = element_blank(),
      axis.line = element_line(color = "black"),
      axis.text = element_text(color = "black"),
      axis.title = element_text(color = "black", face = "bold"),
      plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
      plot.subtitle = element_text(hjust = 0.5, size = 10),
      plot.margin = margin(t = 10, r = 10, b = 10, l = 10)
    ) +
    # Labels
    labs(
      x = "log2(Odds Ratio)",
      y = "-log10(FDR)",
      title = plot_title,
      subtitle = plot_subtitle
    ) +
    guides(fill = "none", color = "none") +
    panel_border(color = "black", linetype = 1, size = 0.5) +
    coord_cartesian(clip = "off")
  
  return(plot)
}

nonsmokers <- read.csv("../data/log-reg-driver-mutations_nonsmokers_threshold10.tsv", sep = "\t")
smokers <- read.csv("../data/log-reg-driver-mutations_smokers_threshold10.tsv", sep = "\t")

# Create individual plots
smoker_plot <- create_volcano_plot(
  smokers,
  "Smokers",
  "Adjusted by age, sex, ancestry, histology & purity"
)

nonsmoker_plot <- create_volcano_plot(
  nonsmokers,
  "Never-smokers",
  "Adjusted by age, sex, ancestry, histology & purity"
)

# Combine plots
combined_plot <- grid.arrange(
  nonsmoker_plot, smoker_plot,
  ncol = 2,
  top = textGrob(
    "Hotspot driver mutations associated with ecDNA",
    gp = gpar(fontsize = 16, fontface = "bold")
  )
)

```



```{r FIGURE 2D -- ecDNA GENOMIC CONTENT BETWEEN NEVER-SMOKERS and SMOKERS}

s <- read.csv("../data/ecDNA_amplicon_table_content.tsv", sep = '\t', header=TRUE)
metadata <- read.csv("../metadata/sherlock_1217_metadata", sep = '\t', header=TRUE)
metadata <- metadata[,c("Tumor_Barcode","Smoking")]
s <- merge(s, metadata, by="Tumor_Barcode", all.x=TRUE)

s$Smoking <- s$Smoking.x


# Define the categories we want to check
categories <- c('Oncogene', 'Other gene', 'Immunomodulatory gene', 'Regulatory region')

genes_to_remove <- c("MDM2", "MYC", "NKX2-1")
#genes_to_remove <- c("MDM2")


# Function to check if any genes_to_remove are in the All_genes string
contains_unwanted_genes <- function(gene_string, unwanted_genes) {
  # Extract genes from the string format
  genes <- gsub("\\[|\\]|'", "", gene_string)  # Remove brackets and quotes
  genes <- trimws(strsplit(genes, ",")[[1]])   # Split by comma and trim whitespace
  
  # Check if any unwanted genes are present
  any(genes %in% unwanted_genes)
}

# Apply the function to filter out rows
s <- s[!sapply(s$Oncogenes, contains_unwanted_genes, genes_to_remove), ]

# Split into smoker and non-smoker groups
nonsmoker <- s[s$Smoking == "Non-Smoker",]
smoker <- s[s$Smoking == "Smoker",]

# Function to process each dataset
process_dataset <- function(df) {
  # For each category, create a new binary column
  for (category in categories) {
    # Create column name
    col_name <- paste0(gsub(" ", "_", category), "_Status")
    
    # Check if the category appears in the Category column
    # The pattern needs to account for the string format in the data
    df[[col_name]] <- ifelse(grepl(paste0("'", category, "'"), df$Category), "Yes", "No")
  }
  
  return(df)
}

# Process both datasets
nonsmoker <- process_dataset(nonsmoker)
smoker <- process_dataset(smoker)

# Check the results
head(nonsmoker)
head(smoker)

# Combine datasets 
combined_data <- rbind(smoker, nonsmoker)


# Ensure smoking is a factor
combined_data$Smoking <- factor(combined_data$Smoking, levels = c("Non-Smoker", "Smoker"))

# Function to create bar plot and perform chi-squared test
create_category_barplot <- function(data, category) {
  # Get the column name for this category
  col_name <- paste0(gsub(" ", "_", category), "_Status")
  
  # Filter out any NAs
  data <- data %>%
    dplyr::filter(!is.na(Smoking) & !is.na(!!sym(col_name)))
  
  # Perform chi-squared test
  contingency_table <- table(data$Smoking, data[[col_name]])
  chi_result <- chisq.test(contingency_table)
  p_value <- chi_result$p.value
  
  # Create subtitle with p-value
  subtitle_text <- paste0("p=", 
                          ifelse(p_value < 0.001, 
                                format.pval(p_value, digits = 2, eps = 0.001), 
                                round(p_value, 3)))
  
  # Just the category name as title
  title <- category
  
  # Process data for plotting
  data_summary <- data %>%
    group_by(Smoking, !!sym(col_name)) %>%
    summarise(count = n(), .groups = "drop") %>%
    group_by(Smoking) %>%
    mutate(
      total = sum(count),
      percentage = count / sum(count) * 100
    )
  
  # Calculate the positions for labels - we'll place them directly in the plot
  # Create a separate dataset for the "Yes" counts and percentages
  yes_data <- data_summary %>% 
    filter(!!sym(col_name) == "Yes") %>%
    mutate(label = paste0("n=", count),  # Removed percentages
           # Position in middle of Yes segment
           position = percentage / 2)
  
  # Create a separate dataset for the "No" counts and percentages
  no_data <- data_summary %>% 
    filter(!!sym(col_name) == "No") %>%
    mutate(label = paste0("n=", count),  # Removed percentages
           # Position in middle of No segment
           position = percentage / 2 + (100 - percentage))
  
  # Get totals for each smoking group
  totals <- data_summary %>%
    group_by(Smoking) %>%
    summarise(total = sum(count))
  
  # Create the plot
  p <- ggplot(data_summary, aes(x = Smoking, y = percentage, fill = !!sym(col_name))) +
    geom_bar(stat = "identity", position = "stack", color = "black") +
    labs(title = title,
         subtitle = subtitle_text,
         y = "Percentage of ecDNA") +
    theme_minimal() +
    scale_fill_manual(values = c("Yes" = "tomato", "No" = "skyblue"), name = NULL) +
     theme(
      plot.title = element_text(size = 12, face = "bold", hjust = 0.5),
      plot.subtitle = element_text(size = 8, hjust = 0.5),
      axis.title.x = element_blank(),  # Remove x-axis title
      axis.text.x = element_blank(),   # Remove x-axis text
      axis.title.y = element_text(size = 8),  # Change y-axis label size
      axis.text.y = element_text(size = 7),   # Change y-axis tick text size
      legend.position = "right",
      legend.key.size = unit(0.4, "cm"),
      legend.text = element_text(size = 7),
      legend.margin = margin(0, 0, 0, 0)
    ) +
    # Add the Yes labels
    geom_text(data = yes_data, 
              aes(y = position, label = label),
              size = 2.3, color = "black") +
    # Add the No labels
    geom_text(data = no_data,
              aes(y = position, label = label),
              size = 2.3, color = "black") +
    # Add total count at the bottom
    geom_text(data = totals,
              aes(x = Smoking, y = -5, label = paste0("n=", total)),
              size = 2.8, color = "black", inherit.aes = FALSE) +
    # Set y-axis limits to ensure there's space for the labels
    ylim(-10, 105)
  
  return(list(
    plot = p,
    chi_test = chi_result,
    contingency_table = contingency_table
  ))
}

# Create individual plots for each category
categories <- c('Oncogene', 'Other gene', 'Immunomodulatory gene', 'Regulatory region')
results_list <- list()
plots_list <- list()

for (category in categories) {
  result <- create_category_barplot(combined_data, category)
  results_list[[category]] <- result
  plots_list[[category]] <- result$plot
}

# Combine plots using patchwork
combined_plot <- (plots_list[[1]] + plots_list[[3]]) / 
                 (plots_list[[4]] + plots_list[[2]]) +
                 plot_layout(guides = "keep") # Keep individual legends

# Add a title to the combined plot
combined_plot <- combined_plot + 
  plot_annotation(
    title = "ecDNA Content by Smoking Status",
    theme = theme(plot.title = element_text(size = 14, face = "bold", hjust = 0.5))
  )

print(combined_plot)

```


```{r FIGURE 2E -- SURVIVAL ANALYSIS}

s <- read.csv("..data/log-reg-table5.tsv", sep="\t", header=TRUE)


#replace all MDM2-non-ecDNA with MDM2-chrAmp in the MDM2_class column 
s$MDM2_class[s$MDM2_class == "MDM2-non-ecDNA"] <- "MDM2-chrAmp"

s$MDM2_class <- factor(s$MDM2_class, levels = c('No MDM2 amp', "MDM2-chrAmp", 'MDM2-ecDNA'))

#make a new column, ecDNA.class2, that combines the "Complex" and "Multi-chromosome" classes into one, "Complex"
s$ecDNAClass2 <- s$ecDNA.class
s$ecDNAClass2[s$ecDNAClass2 == "Multi-chromosome"] <- "Complex"

#replace all occurrences of "Amp not on ecDNA" with "ChromosomalAmp"
s$Classification2[s$Classification2 == "ChromosomalAmp"] <- "chrAmp"
s$Classification2 <- factor(s$Classification2, levels = c('No amp', 'chrAmp', "ecDNA"))



#drop smoking is unknown and stage4 is NA
s <- s %>%
  dplyr::filter(!Smoking %in% c("Unknown", "unknown") & !is.na(Stage_group))


#create an early stage (I) and late stage column
s$Stage_class <- ifelse(s$Stage4 == "I", "Early-stage (I)", "Late-stage (II-IV)")

s$Survival_Month_5yr  <- ifelse(s$Survival_Month >= 60,
                   60, s$Survival_Month)

s$Survival_Month_10yr <- ifelse(s$Survival_Month >= 120,
                            120, s$Survival_Month)

s$Death_5yr <- ifelse(s$Survival_Month >= 60,
                   0, s$Death)

s$Death_10yr <- ifelse(s$Survival_Month >= 120,
                      0, s$Death)

s$ecDNA. <- factor(s$ecDNA., levels = c("ecDNA-", "ecDNA+"))
s$TP53_status <- factor(s$TP53_status, levels = c("TP53-", "TP53+"))
s$Stage_class <- factor(s$Stage_class, levels = c("Early-stage (I)", "Late-stage (II-IV)"))
s$Population <- factor(s$Population, levels = c('EAS', 'EUR', 'Other'))
s$Histology <- factor(s$Histology, levels = c('Adenocarcinoma', "Squamous cell carcinoma", "Carcinoid tumor", "Other"))

s$Gender <- factor(s$Gender, levels = c('Male', 'Female'))
s$Smoking <- factor(s$Smoking, levels = c('Smoker', 'Non-Smoker'))

s$oncogene_class <- factor(s$oncogene_class, levels = c('No oncogene amp', 'oncogene-non-ecDNA', 'oncogene-ecDNA'))

s$EGFR_class <- factor(s$EGFR_class, levels = c('No EGFR amp', 'EGFR-non-ecDNA', 'EGFR-ecDNA'))


s$Classification <- factor(s$Classification, levels = c('None', 'Linear', 'Complex-non-cyclic', "BFB", "ecDNA"))


s$ecDNA_copy_number <- factor(s$ecDNA_copy_number, levels = c('None', 'low-copy', 'high-copy'))
s$ecDNAClass2 <- factor(s$ecDNAClass2, levels = c('None', 'Simple', 'Complex'))

#Replace all "Multi-chromosome" in ecDNA.class column with "Multi-\nchromosome"
s$ecDNA.class <- ifelse(s$ecDNA.class == "Multi-chromosome", "Multi-\nchromosome", s$ecDNA.class)

s$ecDNA.class <- factor(s$ecDNA.class, levels = c('None', 'Simple', 'Complex', "Multi-\nchromosome"))

create_survival_plot <- function(data, time_col, status_col, grouping_var, highlight_level, title, xlim, smoking = NULL, highlight_level2 = NULL) {
  # Ensure that the grouping variable is a factor with correct levels
  data[[grouping_var]] <- factor(data[[grouping_var]])
  
  # Get levels of the grouping variable
  levels_in_data <- levels(data[[grouping_var]])
  
  # Check if the highlight_level is in the grouping variable levels
  if (!(highlight_level %in% levels_in_data)) {
    stop(paste0("The highlight level '", highlight_level, "' is not present in the grouping variable levels."))
  }
  
  
  if (!is.null(smoking)) {
    # Create the adjusted Cox model with Smoking as a covariate
    cox_formula <- as.formula(paste("Surv(", time_col, ",", status_col, ") ~", 
                                    grouping_var, 
                                    "+ Gender + Age + Population + Stage_group + Histology + Smoking"))
  } else {
    # Create the adjusted Cox model without Smoking
    cox_formula <- as.formula(paste("Surv(", time_col, ",", status_col, ") ~", 
                                    grouping_var, 
                                    "+ Gender + Age + Population + Stage_group + Histology + wGII"))
  }
  
  s$Classification2 <- relevel(s$Classification2, ref = "chrAmp")
  cox_model <- coxph(cox_formula, data = data)
  
  # print("Cox model summary:")
  # print(summary(cox_model))
  
  # Extract p-value, HR, and CI
  summary_cox <- summary(cox_model)
  
  print(summary_cox)
  coef_name <- paste0(grouping_var, highlight_level)
  if(coef_name %in% rownames(summary_cox$coefficients)) {
    p_value <- summary_cox$coefficients[coef_name, "Pr(>|z|)"]
    hr <- summary_cox$conf.int[coef_name, "exp(coef)"]
    ci_lower <- summary_cox$conf.int[coef_name, "lower .95"]
    ci_upper <- summary_cox$conf.int[coef_name, "upper .95"]
    
    
    annotation <- sprintf(
      "Cox P = %.4f\nCox HR = %.2f (95%% CI: %.2f-%.2f)",
      p_value, hr, ci_lower, ci_upper
    )
  } else {
    annotation <- "coefficient not found in model"
  }
  
  print("Annotation:")
  print(annotation)
  
  # Get annotations for secondary highlight level if provided
  if (!is.null(highlight_level2)) {
    coef_name2 <- paste0(grouping_var, highlight_level2)
    if(coef_name2 %in% rownames(summary_cox$coefficients)) {
      p_value <- summary_cox$coefficients[coef_name2, "Pr(>|z|)"]
      hr <- summary_cox$conf.int[coef_name2, "exp(coef)"]
      ci_lower <- summary_cox$conf.int[coef_name2, "lower .95"]
      ci_upper <- summary_cox$conf.int[coef_name2, "upper .95"]
      
      annotation2 <- sprintf(
        "%s:\n Cox P = %.4f\nCox HR = %.2f (95%% CI: %.2f-%.2f)",
        highlight_level2, p_value, hr, ci_lower, ci_upper
      )
    }
  }
  
  # Calculate the number of samples in each group for the grouping variable
  group_counts <- table(data[[grouping_var]])
  
  # Create labels by combining group names and sample sizes
  legend_labels <- paste0(names(group_counts), " (", group_counts, ")")
  
  # Add annotation to the plot


  fit <- surv_fit(Surv(data[[time_col]], data[[status_col]]) ~ data[[grouping_var]], data = data)
  
  # Extract strata names generated by survfit
  strata_names <- levels(data[[grouping_var]])
  print("Strata names based on grouping_var levels:")
  print(strata_names)
  
  # Define a custom palette with the specified colors
  color_set <- c("blue", "red",  "green", "black", "purple")
  
  # Create a named palette where the names match the strata names
  custom_palette <- setNames(color_set, strata_names)
  
  # Ensure the highlight_level gets the specified "red" color
  if (highlight_level %in% strata_names) {
    custom_palette[highlight_level] <- "red"  # Explicitly assign red to ecDNA+
  }
  
  
  custom_palette <- c("gray", "blue", "red", "green", "black", "purple") 
                      
  survplot <- ggsurvplot(surv_fit(Surv(data[[time_col]], data[[status_col]]) ~ data[[grouping_var]], data = data), data = data, risk.table = FALSE, pval=FALSE, palette=custom_palette, legend.labs = legend_labels, short.panel.labs=TRUE, font.x=10, font.main=10, font.y=10, font.tickslab=10, xlab = "Time (Months)", legend = c("right"), font.legend = c(8,"plain", "black"))
  

  # Extract the ggplot object from ggsurvplot
  p <- survplot$plot
  
  p <- p +
    annotate("text", x = 0.5, y = 0.01,
             label = annotation, hjust = 0, vjust = 0, size = 4)

  # p <- p +
  #   annotate("text", x = 0.5, y = 0.17,
  #            label = annotation2, hjust = 0, vjust = 0, size = 4)
  return(p)
}

smokers <- s[s$Smoking == "Smoker", ]
nonsmokers <- s[s$Smoking == "Non-Smoker", ]


nonsmoker_plot <- create_survival_plot(nonsmokers, "Survival_Month_5yr", "Death_5yr", "Classification2", "ecDNA", "Survival by Classification", 60, "Smoking", highlight_level2 = "chrAmp")

smoker_plot <- create_survival_plot(smokers, "Survival_Month_5yr", "Death_5yr", "Classification2", "ecDNA", "Survival by Classification", 60, "Smoking", highlight_level2 = "chrAmp")

```



